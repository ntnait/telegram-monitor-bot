import asyncio
import json
import datetime
from pyrogram import Client, filters
from pyrogram.types import Message, ChatPermissions

# Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‡Ù†Ø§
API_ID = 21404699
API_HASH = "e7d05cd13e028832347d489bfdb485ed"
BOT_TOKEN = "8272208548:AAFUwgy_LtCEGlaxRCrY7w53itZP_IqxHs0"

# Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ†
DEV_IDS = [1490559672]  # ØªÙ‚Ø¯Ø± ØªØ¶ÙŠÙ Ø§ÙŠØ¯ÙŠØ§Øª Ø«Ø§Ù†ÙŠØ©

# Ù…Ù„ÙØ§Øª Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
DATA_FILE = "data.json"

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯
try:
    with open(DATA_FILE, "r") as f:
        data = json.load(f)
except:
    data = {
        "non_active_users": {},
        "mute_kick_logs": [],
        "calls": {},
        "groups": {},
        "settings": {}
    }

app = Client("monitor_bot", api_id=API_ID, api_hash=API_HASH, bot_token=BOT_TOKEN)

# Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ
async def save_data():
    while True:
        with open(DATA_FILE, "w") as f:
            json.dump(data, f)
        await asyncio.sleep(60)

# ØªØ­Ù‚Ù‚ Ø§Ø´ØªØ±Ø§Ùƒ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ
async def check_subscription(user_id):
    # Ø¶Ø¹ Ù‡Ù†Ø§ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ù‚Ù†Ø§Ø© Ù…Ø¹ÙŠÙ†Ø© Ù…Ø«Ù„Ø§
    return True

# Ø¥Ø´Ø¹Ø§Ø± Ø¯Ø®ÙˆÙ„ Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯
@app.on_message(filters.new_chat_members)
async def new_member_notify(client: Client, message: Message):
    chat_id = message.chat.id
    for member in message.new_chat_members:
        for dev_id in DEV_IDS:
            await client.send_message(dev_id, f"âœ… Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯ Ø¯Ø®Ù„ Ø§Ù„ÙƒØ±ÙˆØ¨ [{message.chat.title}]: {member.mention}")

        # Ø³Ø¬Ù„ Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if str(chat_id) not in data["groups"]:
            data["groups"][str(chat_id)] = {"members": {}}
        data["groups"][str(chat_id)]["members"][str(member.id)] = {
            "join_date": str(datetime.datetime.now()),
            "messages": 0,
            "calls": 0,
            "muted": False,
            "kicked": False,
            "last_active": str(datetime.datetime.now())
        }

# Ø¥Ø´Ø¹Ø§Ø± Ø®Ø±ÙˆØ¬ Ø¹Ø¶Ùˆ
@app.on_message(filters.left_chat_member)
async def left_member_notify(client: Client, message: Message):
    chat_id = message.chat.id
    user = message.left_chat_member
    for dev_id in DEV_IDS:
        await client.send_message(dev_id, f"âŒ Ø¹Ø¶Ùˆ Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„ÙƒØ±ÙˆØ¨ [{message.chat.title}]: {user.mention}")

    # Ø­Ø¯Ø« Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø±ÙˆØ¬
    if str(chat_id) in data["groups"]:
        if str(user.id) in data["groups"][str(chat_id)]["members"]:
            data["groups"][str(chat_id)]["members"][str(user.id)]["kicked"] = True

# Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ø±Ø¯ ÙˆØ§Ù„ÙƒØªÙ… (ØªØ¹Ø¯ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª)
@app.on_message(filters.group & filters.service)
async def service_monitor(client: Client, message: Message):
    chat_id = message.chat.id
    if message.action:
        # Ø·Ø±Ø¯ Ø¹Ø¶Ùˆ
        if message.action.kicked_user:
            user = message.action.kicked_user
            actor = message.from_user
            for dev_id in DEV_IDS:
                await client.send_message(dev_id, f"â›”ï¸ ØªÙ… Ø·Ø±Ø¯ {user.mention} Ø¨ÙˆØ§Ø³Ø·Ø© {actor.mention} ÙÙŠ {message.chat.title}")
        # ÙƒØªÙ… Ø¹Ø¶Ùˆ
        elif message.action.restricted_user:
            user = message.action.restricted_user
            actor = message.from_user
            for dev_id in DEV_IDS:
                await client.send_message(dev_id, f"ğŸ”‡ ØªÙ… ÙƒØªÙ… {user.mention} Ø¨ÙˆØ§Ø³Ø·Ø© {actor.mention} ÙÙŠ {message.chat.title}")
        # Ø±ÙØ¹ Ø£Ùˆ ØªÙ†Ø²ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª
        elif message.action.promoted_user:
            user = message.action.promoted_user
            actor = message.from_user
            for dev_id in DEV_IDS:
                await client.send_message(dev_id, f"ğŸ”¼ ØªÙ… Ø±ÙØ¹ ØµÙ„Ø§Ø­ÙŠØ§Øª {user.mention} Ø¨ÙˆØ§Ø³Ø·Ø© {actor.mention} ÙÙŠ {message.chat.title}")
        elif message.action.demoted_user:
            user = message.action.demoted_user
            actor = message.from_user
            for dev_id in DEV_IDS:
                await client.send_message(dev_id, f"ğŸ”½ ØªÙ… ØªÙ†Ø²ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª {user.mention} Ø¨ÙˆØ§Ø³Ø·Ø© {actor.mention} ÙÙŠ {message.chat.title}")

# Ø±ØµØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„ØªÙØ§Ø¹Ù„
@app.on_message(filters.group & filters.text)
async def count_messages(client: Client, message: Message):
    chat_id = message.chat.id
    user_id = message.from_user.id
    if str(chat_id) in data["groups"]:
        members = data["groups"][str(chat_id)]["members"]
        if str(user_id) in members:
            members[str(user_id)]["messages"] += 1
            members[str(user_id)]["last_active"] = str(datetime.datetime.now())
        else:
            # Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯ Ù„ÙƒÙ† Ù…Ø§ Ø¯Ø®Ù„ Ø¬Ø¯ÙŠØ¯ ÙƒÙ€ Ø¹Ø¶Ùˆ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§ØªÙ†Ø§
            members[str(user_id)] = {
                "join_date": str(datetime.datetime.now()),
                "messages": 1,
                "calls": 0,
                "muted": False,
                "kicked": False,
                "last_active": str(datetime.datetime.now())
            }

# Ø±ØµØ¯ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª (Ø§Ù„Ø§ØªØµØ§Ù„)
@app.on_message(filters.group & filters.call)
async def monitor_calls(client: Client, message: Message):
    chat_id = message.chat.id
    user_id = message.from_user.id
    now = datetime.datetime.now()
    if str(chat_id) in data["groups"]:
        members = data["groups"][str(chat_id)]["members"]
        if str(user_id) in members:
            members[str(user_id)]["calls"] += 1
            members[str(user_id)]["last_active"] = str(now)
            # ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø°Ø§ ØºÙŠØ± Ù…ØªÙØ§Ø¹Ù„ Ù…Ø«Ù„Ø§Ù‹ Ø£Ù‚Ù„ Ù…Ù† 5 Ø±Ø³Ø§Ø¦Ù„
            if members[str(user_id)]["messages"] < 5:
                for dev_id in DEV_IDS:
                    await client.send_message(dev_id, f"âš ï¸ Ø¹Ø¶Ùˆ {message.from_user.mention} ØºÙŠØ± Ù…ØªÙØ§Ø¹Ù„ ÙˆØµØ¹Ø¯ Ø§ØªØµØ§Ù„ ÙÙŠ {message.chat.title}")

# Ø£ÙˆØ§Ù…Ø± ÙÙŠ Ø§Ù„Ø®Ø§Øµ

# Ø£Ù…Ø± start Ù„Ù„ØªØ±Ø­ÙŠØ¨
@app.on_message(filters.private & filters.command("start"))
async def start_cmd(client: Client, message: Message):
    if await check_subscription(message.from_user.id):
        await message.reply("Ù…Ø±Ø­Ø¨Ø§ØŒ Ø¨ÙˆØª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø´ØºØ§Ù„!")
    else:
        await message.reply("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨ÙˆØª.")

# Ø£Ù…Ø± Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ†
@app.on_message(filters.private & filters.user(DEV_IDS) & filters.command("stats"))
async def stats_cmd(client: Client, message: Message):
    text = "ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª:\n\n"
    for gid, group in data["groups"].items():
        text += f" - {gid} Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: {len(group['members'])}\n"
    await message.reply(text)

# Ù…Ù‡Ù…Ø© ØªØ±Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (ØªØ´ØªØºÙ„ ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©)
async def daily_report():
    await app.wait_until_ready()
    while True:
        for dev_id in DEV_IDS:
            text = "ğŸ“ˆ ØªØ±Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ:\n\n"
            for gid, group in data["groups"].items():
                members = group["members"]
                sorted_members = sorted(members.items(), key=lambda x: x[1]["messages"], reverse=True)
                top_members = sorted_members[:5]
                for user_id, info in top_members:
                    text += f" - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}: {info['messages']} Ø±Ø³Ø§Ù„Ø©\n"
            await app.send_message(dev_id, text)
        await asyncio.sleep(86400)  # 24 Ø³Ø§Ø¹Ø©

# Ù…Ù‡Ù…Ø© Ø¥Ø±Ø³Ø§Ù„ Ù‚Ø§Ø¦Ù…Ø© ØºÙŠØ± Ø§Ù„Ù…ØªÙØ§Ø¹Ù„ÙŠÙ† (ØªØ´ØªØºÙ„ ÙŠÙˆÙ…ÙŠØ§Ù‹)
async def daily_inactive_report():
    await app.wait_until_ready()
    while True:
        for dev_id in DEV_IDS:
            text = "ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© ØºÙŠØ± Ø§Ù„Ù…ØªÙØ§Ø¹Ù„ÙŠÙ†:\n\n"
            for gid, group in data["groups"].items():
                for user_id, info in group["members"].items():
                    if info["messages"] < 1:  # Ø£Ù‚Ù„ Ù…Ù† Ø±Ø³Ø§Ù„Ø©
                        text += f" - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}\n"
            await app.send_message(dev_id, text)
        await asyncio.sleep(86400)

# Ø¨Ø¯Ø¡ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±ÙŠ ÙˆØ§Ù„Ù…Ù‡Ø§Ù…
@app.on_message(filters.private & filters.user(DEV_IDS) & filters.command("starttasks"))
async def start_tasks_cmd(client: Client, message: Message):
    asyncio.create_task(save_data())
    asyncio.create_task(daily_repÙƒort())
    asyncio.create_task(daily_inactive_report())
    await message.reply("ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.")

app.run()
